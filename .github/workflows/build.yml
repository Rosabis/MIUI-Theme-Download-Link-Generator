name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64]
        configuration: [Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgJsonGlob: '**/vcpkg.json'
        runVcpkgInstall: true
      continue-on-error: false
    
    - name: Integrate vcpkg with Visual Studio
      shell: pwsh
      run: |
        vcpkg integrate install
        $env:VCPKG_ROOT = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        echo "VCPKG_ROOT=$env:VCPKG_ROOT" >> $env:GITHUB_ENV
    
    - name: Build solution
      shell: pwsh
      run: |
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        if (-not $vsPath) {
          $vsPath = & "${env:ProgramFiles}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        }
        if (-not $vsPath) {
          Write-Error "MSBuild not found"
          exit 1
        }
        
        $solutionPath = "MIUIThemeDownlaoder.sln"
        $platform = "${{ matrix.platform }}"
        $configuration = "${{ matrix.configuration }}"
        
        Write-Host "Using MSBuild at: $vsPath"
        $vcpkgRoot = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        $vcpkgToolchain = "$vcpkgRoot\scripts\buildsystems\vcpkg.cmake"
        
        & $vsPath $solutionPath `
          /p:Configuration=$configuration `
          /p:Platform=$platform `
          /p:VcpkgEnableManifest=true `
          /p:VCPKG_ROOT=$vcpkgRoot `
          /p:VcpkgToolchainFile=$vcpkgToolchain `
          /m `
          /v:minimal
    
    - name: Find built executable and copy dependencies
      id: package
      shell: pwsh
      run: |
        $rootPath = (Get-Location).Path
        $vcpkgRoot = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        $packageDir = "package"
        New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
        
        Write-Host "Searching for executable in: $rootPath"
        
        # Common output paths for Visual Studio projects
        $searchPaths = @(
          "MIUIThemeDownlaoder\${{ matrix.configuration }}\${{ matrix.platform }}",
          "MIUIThemeDownlaoder\x64\${{ matrix.configuration }}",
          "MIUIThemeDownlaoder\Release\x64",
          "MIUIThemeDownlaoder"
        )
        
        $exePath = $null
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            $found = Get-ChildItem -Path $searchPath -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $exePath = $found
              Write-Host "Found executable in: $searchPath"
              break
            }
          }
        }
        
        # Fallback: search recursively
        if (-not $exePath) {
          $exePath = Get-ChildItem -Path "." -Filter "MIUIThemeDownlaoder.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        }
        
        if (-not $exePath) {
          Write-Error "Executable not found. Listing all .exe files:"
          Get-ChildItem -Path "." -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
        
        Write-Host "Copying executable: $($exePath.FullName)"
        Copy-Item -Path $exePath.FullName -Destination $packageDir -Force
        
        # Copy required DLLs from vcpkg
        $vcpkgInstalledBin = "$vcpkgRoot\installed\x64-windows\bin"
        $vcpkgInstalledDebugBin = "$vcpkgRoot\installed\x64-windows\debug\bin"
        
        Write-Host "Searching for DLLs in vcpkg installed directories..."
        
        # Function to copy DLLs from a directory
        function Copy-DllsFromDirectory {
          param($SourceDir, $TargetDir, $Description)
          if (Test-Path $SourceDir) {
            Write-Host "Copying DLLs from $Description : $SourceDir"
            $dlls = Get-ChildItem -Path $SourceDir -Filter "*.dll" -Recurse -ErrorAction SilentlyContinue
            foreach ($dll in $dlls) {
              $destPath = Join-Path $TargetDir $dll.Name
              Copy-Item -Path $dll.FullName -Destination $destPath -Force
              Write-Host "  Copied: $($dll.Name)"
            }
            return $dlls.Count
          } else {
            Write-Host "  Directory not found: $SourceDir"
            return 0
          }
        }
        
        # Copy from release bin directory
        $count1 = Copy-DllsFromDirectory -SourceDir $vcpkgInstalledBin -TargetDir $packageDir -Description "release bin"
        
        # Copy from debug bin directory (some DLLs might be there)
        $count2 = Copy-DllsFromDirectory -SourceDir $vcpkgInstalledDebugBin -TargetDir $packageDir -Description "debug bin"
        
        # Also check for DLLs in individual package directories
        $packagesDir = "$vcpkgRoot\installed\x64-windows"
        if (Test-Path $packagesDir) {
          Write-Host "Searching in package directories..."
          $packageDirs = Get-ChildItem -Path $packagesDir -Directory -ErrorAction SilentlyContinue
          foreach ($pkgDir in $packageDirs) {
            $binDirs = @(
              "$($pkgDir.FullName)\bin",
              "$($pkgDir.FullName)\tools\bin",
              "$($pkgDir.FullName)\debug\bin"
            )
            foreach ($binDir in $binDirs) {
              if (Test-Path $binDir) {
                $dlls = Get-ChildItem -Path $binDir -Filter "*.dll" -ErrorAction SilentlyContinue
                foreach ($dll in $dlls) {
                  $destPath = Join-Path $packageDir $dll.Name
                  if (-not (Test-Path $destPath)) {
                    Copy-Item -Path $dll.FullName -Destination $destPath -Force
                    Write-Host "  Copied from package: $($dll.Name)"
                  }
                }
              }
            }
          }
        }
        
        Write-Host "Total DLLs copied: $count1 from release, $count2 from debug"
        
        # List all DLLs in package directory
        $finalDlls = Get-ChildItem -Path $packageDir -Filter "*.dll" -ErrorAction SilentlyContinue
        Write-Host "Final DLLs in package:"
        foreach ($dll in $finalDlls) {
          Write-Host "  - $($dll.Name)"
        }
        
        # Create zip package
        $zipPath = "MIUIThemeDownloader-${{ matrix.platform }}-${{ matrix.configuration }}.zip"
        Compress-Archive -Path "$packageDir\*" -DestinationPath $zipPath -Force
        Write-Host "Created package: $zipPath"
        
        echo "package-path=$zipPath" >> $env:GITHUB_OUTPUT
        echo "package-dir=$packageDir" >> $env:GITHUB_OUTPUT
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MIUIThemeDownloader-${{ matrix.platform }}-${{ matrix.configuration }}
        path: ${{ steps.package.outputs.package-path }}
        retention-days: 30

