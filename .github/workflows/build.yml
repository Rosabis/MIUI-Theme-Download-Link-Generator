name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64]
        configuration: [Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgJsonGlob: '**/vcpkg.json'
        runVcpkgInstall: true
    
    - name: Integrate vcpkg with Visual Studio
      shell: pwsh
      run: |
        vcpkg integrate install
        $env:VCPKG_ROOT = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        echo "VCPKG_ROOT=$env:VCPKG_ROOT" >> $env:GITHUB_ENV
    
    - name: Build solution
      shell: pwsh
      run: |
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        if (-not $vsPath) {
          $vsPath = & "${env:ProgramFiles}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        }
        if (-not $vsPath) {
          Write-Error "MSBuild not found"
          exit 1
        }
        
        $solutionPath = "MIUIThemeDownlaoder.sln"
        $platform = "${{ matrix.platform }}"
        $configuration = "${{ matrix.configuration }}"
        
        Write-Host "Using MSBuild at: $vsPath"
        $vcpkgRoot = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        $vcpkgToolchain = "$vcpkgRoot\scripts\buildsystems\vcpkg.cmake"
        
        & $vsPath $solutionPath `
          /p:Configuration=$configuration `
          /p:Platform=$platform `
          /p:VcpkgEnableManifest=true `
          /p:VCPKG_ROOT=$vcpkgRoot `
          /p:VcpkgToolchainFile=$vcpkgToolchain `
          /m `
          /v:minimal
    
    - name: Find built executable
      id: find-exe
      shell: pwsh
      run: |
        $rootPath = (Get-Location).Path
        Write-Host "Searching for executable in: $rootPath"
        
        # Common output paths for Visual Studio projects
        $searchPaths = @(
          "MIUIThemeDownlaoder\${{ matrix.configuration }}\${{ matrix.platform }}",
          "MIUIThemeDownlaoder\x64\${{ matrix.configuration }}",
          "MIUIThemeDownlaoder\Release\x64",
          "MIUIThemeDownlaoder"
        )
        
        $exePath = $null
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            $found = Get-ChildItem -Path $searchPath -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $exePath = $found
              Write-Host "Found executable in: $searchPath"
              break
            }
          }
        }
        
        # Fallback: search recursively
        if (-not $exePath) {
          $exePath = Get-ChildItem -Path "." -Filter "MIUIThemeDownlaoder.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        }
        
        if ($exePath) {
          $relativePath = $exePath.FullName.Replace("$rootPath\", "").Replace("$rootPath", "")
          echo "exe-path=$relativePath" >> $env:GITHUB_OUTPUT
          echo "exe-name=$($exePath.Name)" >> $env:GITHUB_OUTPUT
          Write-Host "Executable found: $relativePath"
        } else {
          Write-Error "Executable not found. Listing all .exe files:"
          Get-ChildItem -Path "." -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MIUIThemeDownloader-${{ matrix.platform }}-${{ matrix.configuration }}
        path: ${{ steps.find-exe.outputs.exe-path }}
        retention-days: 30

