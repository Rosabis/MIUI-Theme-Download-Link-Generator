name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64]
        configuration: [Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgJsonGlob: '**/vcpkg.json'
        runVcpkgInstall: true
    
    - name: Integrate vcpkg with Visual Studio
      shell: pwsh
      run: |
        vcpkg integrate install
        $env:VCPKG_ROOT = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        echo "VCPKG_ROOT=$env:VCPKG_ROOT" >> $env:GITHUB_ENV
    
    - name: Build solution
      shell: pwsh
      run: |
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        if (-not $vsPath) {
          $vsPath = & "${env:ProgramFiles}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        }
        if (-not $vsPath) {
          Write-Error "MSBuild not found"
          exit 1
        }
        
        $solutionPath = "MIUIThemeDownlaoder.sln"
        $platform = "${{ matrix.platform }}"
        $configuration = "${{ matrix.configuration }}"
        
        Write-Host "Using MSBuild at: $vsPath"
        $vcpkgRoot = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        $vcpkgToolchain = "$vcpkgRoot\scripts\buildsystems\vcpkg.cmake"
        
        & $vsPath $solutionPath `
          /p:Configuration=$configuration `
          /p:Platform=$platform `
          /p:VcpkgEnableManifest=true `
          /p:VCPKG_ROOT=$vcpkgRoot `
          /p:VcpkgToolchainFile=$vcpkgToolchain `
          /m `
          /v:minimal
    
    - name: Find built executable and copy dependencies
      id: package
      shell: pwsh
      run: |
        $rootPath = (Get-Location).Path
        $vcpkgRoot = "${{ env.RUNVCPKG_VCPKG_ROOT }}"
        $packageDir = "package"
        New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
        
        Write-Host "Searching for executable in: $rootPath"
        
        # Common output paths for Visual Studio projects
        $searchPaths = @(
          "MIUIThemeDownlaoder\${{ matrix.configuration }}\${{ matrix.platform }}",
          "MIUIThemeDownlaoder\x64\${{ matrix.configuration }}",
          "MIUIThemeDownlaoder\Release\x64",
          "MIUIThemeDownlaoder"
        )
        
        $exePath = $null
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            $found = Get-ChildItem -Path $searchPath -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $exePath = $found
              Write-Host "Found executable in: $searchPath"
              break
            }
          }
        }
        
        # Fallback: search recursively
        if (-not $exePath) {
          $exePath = Get-ChildItem -Path "." -Filter "MIUIThemeDownlaoder.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        }
        
        if (-not $exePath) {
          Write-Error "Executable not found. Listing all .exe files:"
          Get-ChildItem -Path "." -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
        
        Write-Host "Copying executable: $($exePath.FullName)"
        Copy-Item -Path $exePath.FullName -Destination $packageDir -Force
        
        # Copy required DLLs from vcpkg
        $vcpkgInstalled = "$vcpkgRoot\installed\x64-windows\bin"
        if (Test-Path $vcpkgInstalled) {
          Write-Host "Copying DLLs from: $vcpkgInstalled"
          
          # Copy jsoncpp DLL
          $jsoncppDll = Get-ChildItem -Path $vcpkgInstalled -Filter "jsoncpp*.dll" -ErrorAction SilentlyContinue
          if ($jsoncppDll) {
            Copy-Item -Path $jsoncppDll.FullName -Destination $packageDir -Force
            Write-Host "Copied: $($jsoncppDll.Name)"
          }
          
          # Copy curl DLL
          $curlDll = Get-ChildItem -Path $vcpkgInstalled -Filter "*curl*.dll" -ErrorAction SilentlyContinue
          if ($curlDll) {
            Copy-Item -Path $curlDll.FullName -Destination $packageDir -Force
            Write-Host "Copied: $($curlDll.Name)"
          }
          
          # Copy wxWidgets DLLs
          $wxDlls = Get-ChildItem -Path $vcpkgInstalled -Filter "wx*.dll" -ErrorAction SilentlyContinue
          if ($wxDlls) {
            foreach ($dll in $wxDlls) {
              Copy-Item -Path $dll.FullName -Destination $packageDir -Force
              Write-Host "Copied: $($dll.Name)"
            }
          }
          
          # Copy all other DLLs that might be needed
          $allDlls = Get-ChildItem -Path $vcpkgInstalled -Filter "*.dll" -ErrorAction SilentlyContinue
          foreach ($dll in $allDlls) {
            $destPath = Join-Path $packageDir $dll.Name
            if (-not (Test-Path $destPath)) {
              Copy-Item -Path $dll.FullName -Destination $packageDir -Force
              Write-Host "Copied: $($dll.Name)"
            }
          }
        } else {
          Write-Warning "vcpkg installed directory not found: $vcpkgInstalled"
        }
        
        # Create zip package
        $zipPath = "MIUIThemeDownloader-${{ matrix.platform }}-${{ matrix.configuration }}.zip"
        Compress-Archive -Path "$packageDir\*" -DestinationPath $zipPath -Force
        Write-Host "Created package: $zipPath"
        
        echo "package-path=$zipPath" >> $env:GITHUB_OUTPUT
        echo "package-dir=$packageDir" >> $env:GITHUB_OUTPUT
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MIUIThemeDownloader-${{ matrix.platform }}-${{ matrix.configuration }}
        path: ${{ steps.package.outputs.package-path }}
        retention-days: 30

